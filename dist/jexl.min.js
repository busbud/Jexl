require=function e(t,r,n){function a(s,i){if(!r[s]){if(!t[s]){var p="function"==typeof require&&require;if(!i&&p)return p(s,!0);if(o)return o(s,!0);var u=new Error("Cannot find module '"+s+"'");throw u.code="MODULE_NOT_FOUND",u}var c=r[s]={exports:{}};t[s][0].call(c.exports,function(e){var r=t[s][1][e];return a(r||e)},c,c.exports,e,t,r,n)}return r[s].exports}for(var o="function"==typeof require&&require,s=0;s<n.length;s++)a(n[s]);return a}({1:[function(e,t,r){function n(e){this._grammar=e}var a=["'(?:(?:\\\\')?[^'])*'",'"(?:(?:\\\\")?[^"])*"',"\\s+","\\btrue\\b","\\bfalse\\b"],o=["\\b[a-zA-Z_\\$][a-zA-Z0-9_\\$]*\\b","(?:(?:[0-9]*\\.[0-9]+)|[0-9]+)"],s=["binaryOp","unaryOp","openParen","openBracket","question","colon"];n.prototype.getElements=function(e){var t=this._getSplitRegex();return e.split(t).filter(function(e){return e})},n.prototype.getTokens=function(e){for(var t=[],r=!1,n=0;n<e.length;n++)this._isWhitespace(e[n])?t.length&&(t[t.length-1].raw+=e[n]):"-"===e[n]&&this._isNegative(t)?r=!0:(r&&(e[n]="-"+e[n],r=!1),t.push(this._createToken(e[n])));return r&&t.push(this._createToken("-")),t},n.prototype.tokenize=function(e){var t=this.getElements(e);return this.getTokens(t)},n.prototype._createToken=function(e){var t={type:"literal",value:e,raw:e};if('"'==e[0]||"'"==e[0])t.value=this._unquote(e);else if(e.match(/^-?(?:(?:[0-9]*\.[0-9]+)|[0-9]+)$/))t.value=parseFloat(e);else if("true"===e||"false"===e)t.value="true"===e;else if(this._grammar[e])t.type=this._grammar[e].type;else{if(!e.match(/^[a-zA-Z_\$][a-zA-Z0-9_\$]*$/))throw new Error("Invalid expression token: "+e);t.type="identifier"}return t},n.prototype._escapeRegExp=function(e){return e=e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),e.match(/^[a-zA-Z_\$][a-zA-Z0-9_\$]*$/)&&(e="\\b"+e+"\\b"),e},n.prototype._getSplitRegex=function(){if(!this._splitRegex){var e=Object.keys(this._grammar);e=e.sort(function(e,t){return t.length-e.length}).map(function(e){return this._escapeRegExp(e)},this),this._splitRegex=new RegExp("("+[a.join("|"),e.join("|"),o.join("|")].join("|")+")")}return this._splitRegex},n.prototype._isNegative=function(e){return!e.length||s.some(function(t){return t===e[e.length-1].type})};var i=/^\s*$/;n.prototype._isWhitespace=function(e){return i.test(e)},n.prototype._unquote=function(e){var t=e[0],r=new RegExp("\\\\"+t,"g");return e.substr(1,e.length-2).replace(r,t).replace(/\\\\/,"\\")},t.exports=n},{}],2:[function(e,t,r){var n=e("./handlers"),a=function(e,t,r,n){this._grammar=e,this._transforms=t||{},this._context=r||{},this._relContext=n||this._context};a.prototype.eval=function(e){return n[e.type].call(this,e)},a.prototype.evalArray=function(e){return e.map(function(e){return this.eval(e)},this)},a.prototype.evalMap=function(e){var t=Object.keys(e),r={};return t.map(function(t){return this.eval(e[t])},this).forEach(function(e,n){r[t[n]]=e}),r},a.prototype._filterRelative=function(e,t){Array.isArray(e)||(e=[e]);var r=e.map(function(e){return new a(this._grammar,this._transforms,this._context,e).eval(t)},this),n=[];return r.forEach(function(t,r){t&&n.push(e[r])}),n},a.prototype._filterStatic=function(e,t){var r=this.eval(t);return"boolean"==typeof r?r?e:void 0:e[r]},t.exports=a},{"./handlers":3}],3:[function(e,t,r){r.ArrayLiteral=function(e){return this.evalArray(e.value)},r.BinaryExpression=function(e){return this._grammar[e.operator].eval(this.eval(e.left),this.eval(e.right))},r.ConditionalExpression=function(e){var t=this.eval(e.test);return t?e.consequent?this.eval(e.consequent):t:this.eval(e.alternate)},r.FilterExpression=function(e){var t=this.eval(e.subject);return e.relative?this._filterRelative(t,e.expr):this._filterStatic(t,e.expr)},r.Identifier=function(e){if(e.from){var t=this.eval(e.from);if(void 0===t)return;return Array.isArray(t)&&(t=t[0]),t[e.value]}return e.relative?this._relContext[e.value]:this._context[e.value]},r.Literal=function(e){return e.value},r.ObjectLiteral=function(e){return this.evalMap(e.value)},r.Transform=function(e){var t=this._transforms[e.name];if(!t)throw new Error("Transform '"+e.name+"' is not defined.");var r=this.eval(e.subject),n=this.evalArray(e.args||[]);return t.apply(null,[r].concat(n))},r.UnaryExpression=function(e){return this._grammar[e.operator].eval(this.eval(e.right))}},{}],4:[function(e,t,r){r.elements={".":{type:"dot"},"[":{type:"openBracket"},"]":{type:"closeBracket"},"|":{type:"pipe"},"{":{type:"openCurl"},"}":{type:"closeCurl"},":":{type:"colon"},",":{type:"comma"},"(":{type:"openParen"},")":{type:"closeParen"},"?":{type:"question"},"+":{type:"binaryOp",precedence:30,eval:function(e,t){return e+t}},"-":{type:"binaryOp",precedence:30,eval:function(e,t){return e-t}},"*":{type:"binaryOp",precedence:40,eval:function(e,t){return e*t}},"/":{type:"binaryOp",precedence:40,eval:function(e,t){return e/t}},"//":{type:"binaryOp",precedence:40,eval:function(e,t){return Math.floor(e/t)}},"%":{type:"binaryOp",precedence:50,eval:function(e,t){return e%t}},"^":{type:"binaryOp",precedence:50,eval:function(e,t){return Math.pow(e,t)}},"==":{type:"binaryOp",precedence:20,eval:function(e,t){return e==t}},"!=":{type:"binaryOp",precedence:20,eval:function(e,t){return e!=t}},">":{type:"binaryOp",precedence:20,eval:function(e,t){return e>t}},">=":{type:"binaryOp",precedence:20,eval:function(e,t){return e>=t}},"<":{type:"binaryOp",precedence:20,eval:function(e,t){return e<t}},"<=":{type:"binaryOp",precedence:20,eval:function(e,t){return e<=t}},"&&":{type:"binaryOp",precedence:10,eval:function(e,t){return e&&t}},"||":{type:"binaryOp",precedence:10,eval:function(e,t){return e||t}},in:{type:"binaryOp",precedence:20,eval:function(e,t){return"string"==typeof t?-1!==t.indexOf(e):!!Array.isArray(t)&&t.some(function(t){return t==e})}},"!":{type:"unaryOp",precedence:1/0,eval:function(e){return!e}}}},{}],5:[function(e,t,r){function n(e,t,r){this._grammar=e,this._state="expectOperand",this._tree=null,this._exprStr=t||"",this._relative=!1,this._stopMap=r||{}}var a=e("./handlers"),o=e("./states").states;n.prototype.addToken=function(e){if("complete"==this._state)throw new Error("Cannot add a new token to a completed Parser");var t=o[this._state],r=this._exprStr;if(this._exprStr+=e.raw,t.subHandler){this._subParser||this._startSubExpression(r);var n=this._subParser.addToken(e);if(n){if(this._endSubExpression(),this._parentStop)return n;this._state=n}}else{if(!t.tokenTypes[e.type]){if(this._stopMap[e.type])return this._stopMap[e.type];throw new Error("Token "+e.raw+" ("+e.type+") unexpected in expression: "+this._exprStr)}var s=t.tokenTypes[e.type],i=a[e.type];s.handler&&(i=s.handler),i&&i.call(this,e),s.toState&&(this._state=s.toState)}return!1},n.prototype.addTokens=function(e){e.forEach(this.addToken,this)},n.prototype.complete=function(){if(this._cursor&&!o[this._state].completable)throw new Error("Unexpected end of expression: "+this._exprStr);return this._subParser&&this._endSubExpression(),this._state="complete",this._cursor?this._tree:null},n.prototype.isRelative=function(){return this._relative},n.prototype._endSubExpression=function(){o[this._state].subHandler.call(this,this._subParser.complete()),this._subParser=null},n.prototype._placeAtCursor=function(e){this._cursor?(this._cursor.right=e,this._setParent(e,this._cursor)):this._tree=e,this._cursor=e},n.prototype._placeBeforeCursor=function(e){this._cursor=this._cursor._parent,this._placeAtCursor(e)},n.prototype._setParent=function(e,t){Object.defineProperty(e,"_parent",{value:t,writable:!0})},n.prototype._startSubExpression=function(e){var t=o[this._state].endStates;t||(this._parentStop=!0,t=this._stopMap),this._subParser=new n(this._grammar,e,t)},t.exports=n},{"./handlers":6,"./states":7}],6:[function(e,t,r){r.argVal=function(e){this._cursor.args.push(e)},r.arrayStart=function(){this._placeAtCursor({type:"ArrayLiteral",value:[]})},r.arrayVal=function(e){e&&this._cursor.value.push(e)},r.binaryOp=function(e){for(var t=this._grammar[e.value].precedence||0,r=this._cursor._parent;r&&r.operator&&this._grammar[r.operator].precedence>=t;)this._cursor=r,r=r._parent;var n={type:"BinaryExpression",operator:e.value,left:this._cursor};this._setParent(this._cursor,n),this._cursor=r,this._placeAtCursor(n)},r.dot=function(){this._nextIdentEncapsulate=this._cursor&&("BinaryExpression"!=this._cursor.type||"BinaryExpression"==this._cursor.type&&this._cursor.right)&&"UnaryExpression"!=this._cursor.type,this._nextIdentRelative=!this._cursor||this._cursor&&!this._nextIdentEncapsulate,this._nextIdentRelative&&(this._relative=!0)},r.filter=function(e){this._placeBeforeCursor({type:"FilterExpression",expr:e,relative:this._subParser.isRelative(),subject:this._cursor})},r.identifier=function(e){var t={type:"Identifier",value:e.value};this._nextIdentEncapsulate?(t.from=this._cursor,this._placeBeforeCursor(t),this._nextIdentEncapsulate=!1):(this._nextIdentRelative&&(t.relative=!0),this._placeAtCursor(t))},r.literal=function(e){this._placeAtCursor({type:"Literal",value:e.value})},r.objKey=function(e){this._curObjKey=e.value},r.objStart=function(){this._placeAtCursor({type:"ObjectLiteral",value:{}})},r.objVal=function(e){this._cursor.value[this._curObjKey]=e},r.subExpression=function(e){this._placeAtCursor(e)},r.ternaryEnd=function(e){this._cursor.alternate=e},r.ternaryMid=function(e){this._cursor.consequent=e},r.ternaryStart=function(){this._tree={type:"ConditionalExpression",test:this._tree},this._cursor=this._tree},r.transform=function(e){this._placeBeforeCursor({type:"Transform",name:e.value,args:[],subject:this._cursor})},r.unaryOp=function(e){this._placeAtCursor({type:"UnaryExpression",operator:e.value})}},{}],7:[function(e,t,r){var n=e("./handlers");r.states={expectOperand:{tokenTypes:{literal:{toState:"expectBinOp"},identifier:{toState:"identifier"},unaryOp:{},openParen:{toState:"subExpression"},openCurl:{toState:"expectObjKey",handler:n.objStart},dot:{toState:"traverse"},openBracket:{toState:"arrayVal",handler:n.arrayStart}}},expectBinOp:{tokenTypes:{binaryOp:{toState:"expectOperand"},pipe:{toState:"expectTransform"},dot:{toState:"traverse"},question:{toState:"ternaryMid",handler:n.ternaryStart}},completable:!0},expectTransform:{tokenTypes:{identifier:{toState:"postTransform",handler:n.transform}}},expectObjKey:{tokenTypes:{identifier:{toState:"expectKeyValSep",handler:n.objKey},closeCurl:{toState:"expectBinOp"}}},expectKeyValSep:{tokenTypes:{colon:{toState:"objVal"}}},postTransform:{tokenTypes:{openParen:{toState:"argVal"},binaryOp:{toState:"expectOperand"},dot:{toState:"traverse"},openBracket:{toState:"filter"},pipe:{toState:"expectTransform"}},completable:!0},postTransformArgs:{tokenTypes:{binaryOp:{toState:"expectOperand"},dot:{toState:"traverse"},openBracket:{toState:"filter"},pipe:{toState:"expectTransform"}},completable:!0},identifier:{tokenTypes:{binaryOp:{toState:"expectOperand"},dot:{toState:"traverse"},openBracket:{toState:"filter"},pipe:{toState:"expectTransform"},question:{toState:"ternaryMid",handler:n.ternaryStart}},completable:!0},traverse:{tokenTypes:{identifier:{toState:"identifier"}}},filter:{subHandler:n.filter,endStates:{closeBracket:"identifier"}},subExpression:{subHandler:n.subExpression,endStates:{closeParen:"expectBinOp"}},argVal:{subHandler:n.argVal,endStates:{comma:"argVal",closeParen:"postTransformArgs"}},objVal:{subHandler:n.objVal,endStates:{comma:"expectObjKey",closeCurl:"expectBinOp"}},arrayVal:{subHandler:n.arrayVal,endStates:{comma:"arrayVal",closeBracket:"expectBinOp"}},ternaryMid:{subHandler:n.ternaryMid,endStates:{colon:"ternaryEnd"}},ternaryEnd:{subHandler:n.ternaryEnd,completable:!0}}},{"./handlers":6}],Jexl:[function(e,t,r){function n(){this._customGrammar=null,this._lexer=null,this._transforms={},this._parserCache={}}var a=e("./evaluator/Evaluator"),o=e("./Lexer"),s=e("./parser/Parser"),i=e("./grammar").elements;n.prototype.addBinaryOp=function(e,t,r){this._addGrammarElement(e,{type:"binaryOp",precedence:t,eval:r})},n.prototype.addUnaryOp=function(e,t){this._addGrammarElement(e,{type:"unaryOp",weight:1/0,eval:t})},n.prototype.addTransform=function(e,t){this._transforms[e]=t},n.prototype.addTransforms=function(e){for(var t in e)e.hasOwnProperty(t)&&(this._transforms[t]=e[t])},n.prototype.getTransform=function(e){return this._transforms[e]},n.prototype.eval=function(e,t){return t||(t={}),this._eval(e,t)},n.prototype.removeOp=function(e){var t=this._getCustomGrammar();!t[e]||"binaryOp"!=t[e].type&&"unaryOp"!=t[e].type||(delete t[e],this._lexer=null),this._clearParserCache()},n.prototype._addGrammarElement=function(e,t){this._getCustomGrammar()[e]=t,this._lexer=null,this._clearParserCache()},n.prototype._eval=function(e,t){var r=this,n=this._getGrammar(),o=new a(n,this._transforms,t),i=this._getParserCache(e);if(i)return o.eval(i);var p=new s(n);p.addTokens(r._getLexer().tokenize(e));var u=p.complete();return r._setParserCache(e,u),o.eval(u)},n.prototype._getCustomGrammar=function(){if(!this._customGrammar){this._customGrammar={};for(var e in i)i.hasOwnProperty(e)&&(this._customGrammar[e]=i[e])}return this._customGrammar},n.prototype._getGrammar=function(){return this._customGrammar||i},n.prototype._getLexer=function(){return this._lexer||(this._lexer=new o(this._getGrammar())),this._lexer},n.prototype._setParserCache=function(e,t){this._parserCache[e]=t},n.prototype._getParserCache=function(e){return this._parserCache[e]||null},n.prototype._clearParserCache=function(){this._parserCache={}},t.exports=new n,t.exports.Jexl=n},{"./Lexer":1,"./evaluator/Evaluator":2,"./grammar":4,"./parser/Parser":5}]},{},[]);